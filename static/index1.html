<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PulseAI - Your Medical Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary {
            background: linear-gradient(135deg, #5a67d8 0%, #805ad5 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af;
            display: inline-block; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Loading Spinner -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-medium text-gray-700">Initializing PulseAI...</p>
        </div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full gradient-bg text-white mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l-1.334 1.779a.5.5 0 01-.812 0L9.22 15H5a2 2 0 01-2-2V5zm2-1a1 1 0 00-1 1v8a1 1 0 001 1h4.44l.667.889a.5.5 0 00.788 0l.667-.889H15a1 1 0 001-1V5a1 1 0 00-1-1H5z" clip-rule="evenodd" /><path d="M7 8a1 1 0 112 0 1 1 0 01-2 0zm4 0a1 1 0 112 0 1 1 0 01-2 0z" /></svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Welcome to PulseAI</h1>
                <p class="text-gray-500 mt-2">Your Secure Medical Assistant</p>
            </div>
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <div id="auth-form">
                    <div class="flex border-b mb-6">
                        <button id="login-tab" class="flex-1 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600">Login</button>
                        <button id="register-tab" class="flex-1 py-2 font-semibold text-gray-500">Register</button>
                    </div>
                    <p id="auth-error" class="text-red-500 text-sm mb-4 text-center"></p>
                    <form id="login-form">
                        <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label><input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-lg">Login</button>
                    </form>
                    <form id="register-form" class="hidden">
                        <div class="mb-4"><label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label><input type="email" id="register-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div class="mb-6"><label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="register-password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"><p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p></div>
                        <button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-lg">Create Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="h-screen w-screen flex hidden">
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center space-x-3"><div class="w-10 h-10 rounded-lg gradient-bg flex items-center justify-center text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l-1.334 1.779a.5.5 0 01-.812 0L9.22 15H5a2 2 0 01-2-2V5zm2-1a1 1 0 00-1 1v8a1 1 0 001 1h4.44l.667.889a.5.5 0 00.788 0l.667-.889H15a1 1 0 001-1V5a1 1 0 00-1-1H5z" clip-rule="evenodd" /></svg></div><h1 class="text-xl font-bold">PulseAI</h1></div>
            <nav class="flex-1 p-4 space-y-2"><button id="new-chat-btn" class="w-full flex items-center space-x-3 px-3 py-2 rounded-lg btn-primary text-white font-semibold"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg><span>New Chat</span></button><h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider pt-4">Recent Chats</h3><div id="chat-history" class="space-y-1"></div></nav>
            <div class="p-4 border-t border-gray-200"><div class="flex items-center space-x-3 mb-4"><div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-indigo-600" id="user-initial"></div><span id="user-email" class="text-sm font-medium truncate"></span></div><button id="logout-btn" class="w-full flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-600 font-semibold"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5.414L12.586 14l-1.414 1.414a1 1 0 001.414 1.414l9-9a1 1 0 000-1.414l-9-9a1 1 0 00-1.414 1.414L11.586 12H4a1 1 0 00-1-1z" clip-rule="evenodd" /></svg><span>Logout</span></button></div>
        </aside>
        <main class="flex-1 flex flex-col bg-gray-50">
            <div id="chat-welcome" class="flex-1 flex flex-col items-center justify-center text-center p-8">
                 <div class="w-20 h-20 rounded-2xl gradient-bg flex items-center justify-center text-white mb-6"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 00-1 1v.5a1.5 1.5 0 01-3 0v-.5a1 1 0 00-1-1H6a1 1 0 01-1-1v-3a1 1 0 011-1h.5a1.5 1.5 0 000-3H6a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" /></svg></div>
                <h2 class="text-3xl font-bold text-gray-800">How can I help you today?</h2><p class="text-gray-500 mt-2 max-w-md">Ask me anything about your medical documents. I'm here to provide quick and accurate information.</p>
                <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-2xl"><button class="suggestion-chip">What are symptoms of the flu?</button><button class="suggestion-chip">Explain Type 2 diabetes</button><button class="suggestion-chip">Common side effects of Aspirin</button><button class="suggestion-chip">Tell me about preventative care</button></div>
            </div>
            <div id="chat-conversation" class="flex-1 flex flex-col hidden">
                <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-white">
                    <h2 class="text-lg font-semibold text-gray-800">Conversation</h2>
                    <button id="summarize-btn" class="flex items-center space-x-2 px-3 py-1.5 text-sm font-semibold text-indigo-600 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a.5.5 0 01.5.5v15a.5.5 0 01-1 0v-15A.5.5 0 015 2zM15 2a.5.5 0 01.5.5v15a.5.5 0 01-1 0v-15A.5.5 0 0115 2zM9.5 2a.5.5 0 01.5.5v15a.5.5 0 01-1 0v-15a.5.5 0 01.5-.5z" clip-rule="evenodd" /></svg>
                        <span>✨ Summarize Chat</span>
                    </button>
                </div>
                <div id="chat-messages" class="chat-container flex-1 p-6 space-y-6 overflow-y-auto"></div>
            </div>
            <div class="p-6 border-t border-gray-200 bg-white">
                <div class="relative"><input id="chat-input" type="text" placeholder="Ask a medical question..." class="w-full pl-4 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"><button id="send-btn" class="absolute inset-y-0 right-0 flex items-center justify-center w-12 h-full text-white rounded-r-lg btn-primary"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg></button></div>
                <p class="text-xs text-gray-400 mt-2 text-center">Disclaimer: PulseAI is an informational tool and not a substitute for professional medical advice.</p>
            </div>
        </main>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 z-40 hidden">
        <div class="modal-backdrop fixed inset-0 bg-black/50"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8 transform transition-all" id="summary-modal-content">
                <div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold text-gray-800">✨ Conversation Summary</h2><button id="close-summary-btn" class="text-gray-400 hover:text-gray-600">&times;</button></div>
                <div id="summary-text" class="text-gray-600 space-y-4 max-h-[60vh] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, query, onSnapshot, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pulseai-app-v2';
    const firebaseConfig = {
  apiKey: "AIzaSyBl5N7dBJk1vyOr-JcUF4Tw4SZWlGm9HjY",
  authDomain: "pulseai-f908c.firebaseapp.com",
  projectId: "pulseai-f908c",
  storageBucket: "pulseai-f908c.firebasestorage.app",
  messagingSenderId: "481024494818",
  appId: "1:481024494818:web:9fbe2bd57e7a0097f3e2bb",
  measurementId: "G-VT24R2FFXE"
};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // Leave blank, handled by environment

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500">Error: Could not connect to services.</p>`;
        }
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailDisplay = document.getElementById('user-email');
        const userInitialDisplay = document.getElementById('user-initial');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessages = document.getElementById('chat-messages');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryContainer = document.getElementById('chat-history');
        const chatWelcome = document.getElementById('chat-welcome');
        const chatConversation = document.getElementById('chat-conversation');
        const summarizeBtn = document.getElementById('summarize-btn');
        const summaryModal = document.getElementById('summary-modal');
        const summaryText = document.getElementById('summary-text');
        const closeSummaryBtn = document.getElementById('close-summary-btn');

        let currentUserId = null;
        let currentConversationId = null;
        let unsubscribeChatHistory = null;
        let unsubscribeMessages = null;

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                userEmailDisplay.textContent = user.email || 'Anonymous User';
                userInitialDisplay.textContent = (user.email || 'A').charAt(0).toUpperCase();
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
                startNewConversation();
                listenForChatHistory();
            } else {
                currentUserId = null;
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                loadingOverlay.classList.add('hidden');
                if (unsubscribeChatHistory) unsubscribeChatHistory();
                if (unsubscribeMessages) unsubscribeMessages();
            }
        });
        
        (async () => {
            if (auth && initialAuthToken) {
                try { await signInWithCustomToken(auth, initialAuthToken); } catch (error) { console.error("Token sign-in failed:", error); await signInAnonymously(auth); }
            } else if (auth) { await signInAnonymously(auth); }
        })();

        loginTab.addEventListener('click', () => {
            loginTab.classList.add('text-indigo-600', 'border-indigo-600'); loginTab.classList.remove('text-gray-500');
            registerTab.classList.remove('text-indigo-600', 'border-indigo-600'); registerTab.classList.add('text-gray-500');
            loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); authError.textContent = '';
        });
        registerTab.addEventListener('click', () => {
            registerTab.classList.add('text-indigo-600', 'border-indigo-600'); registerTab.classList.remove('text-gray-500');
            loginTab.classList.remove('text-indigo-600', 'border-indigo-600'); loginTab.classList.add('text-gray-500');
            registerForm.classList.remove('hidden'); loginForm.classList.add('hidden'); authError.textContent = '';
        });
        loginForm.addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = error.message; } });
        registerForm.addEventListener('submit', async e => { e.preventDefault(); try { const cred = await createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value); await setDoc(doc(db, `artifacts/${appId}/users`, cred.user.uid), { email: cred.user.email, createdAt: new Date() }); authError.textContent = ''; } catch (error) { authError.textContent = error.message; } });
        logoutBtn.addEventListener('click', () => signOut(auth));

        function addMessageToUI(sender, text, isTyping = false, followUps = []) {
            const existingFollowUps = document.getElementById('follow-ups-container');
            if(existingFollowUps) existingFollowUps.remove();

            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'items-start', 'space-x-3', 'max-w-xl');
            if (sender === 'user') messageWrapper.classList.add('ml-auto', 'flex-row-reverse', 'space-x-reverse');
            
            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold';
            if (sender === 'user') {
                avatar.classList.add('bg-indigo-100', 'text-indigo-600');
                avatar.textContent = (auth.currentUser.email || 'U').charAt(0).toUpperCase();
            } else {
                avatar.classList.add('gradient-bg', 'text-white');
                avatar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 00-1 1v.5a1.5 1.5 0 01-3 0v-.5a1 1 0 00-1-1H6a1 1 0 01-1-1v-3a1 1 0 011-1h.5a1.5 1.5 0 000-3H6a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" /></svg>`;
            }

            const messageBubble = document.createElement('div');
            if (sender === 'user') messageBubble.className = 'bg-indigo-500 text-white rounded-lg p-3';
            else messageBubble.className = 'bg-white text-gray-800 rounded-lg p-3 shadow-sm';

            if (isTyping) {
                messageBubble.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
                messageBubble.id = 'typing-bubble';
            } else {
                messageBubble.textContent = text;
            }
            
            messageWrapper.appendChild(messageBubble);
            messageWrapper.appendChild(avatar);
            chatMessages.appendChild(messageWrapper);

            if (sender === 'bot' && followUps.length > 0) {
                const followUpsContainer = document.createElement('div');
                followUpsContainer.id = 'follow-ups-container';
                followUpsContainer.className = 'flex flex-wrap gap-2 mt-2 max-w-xl';
                followUps.forEach(f => {
                    const chip = document.createElement('button');
                    chip.className = 'suggestion-chip text-sm';
                    chip.textContent = `✨ ${f}`;
                    chip.onclick = () => { chatInput.value = f; handleSendMessage(); };
                    followUpsContainer.appendChild(chip);
                });
                chatMessages.appendChild(followUpsContainer);
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handleSendMessage() {
            const question = chatInput.value.trim();
            if (!question) return;
            chatInput.value = '';
            showConversationView();
            addMessageToUI('user', question);
            await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentConversationId}/messages`), { sender: 'user', text: question, timestamp: new Date() });
            addMessageToUI('bot', '', true);

            try {
                const response = await fetch('/ask', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: question }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const answer = data.answer || "Sorry, I couldn't get a response.";
                document.getElementById('typing-bubble')?.parentElement.remove();
                
                // Get follow-up suggestions from Gemini
                const followUps = await getFollowUpSuggestions(question, answer);
                addMessageToUI('bot', answer, false, followUps);

                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentConversationId}/messages`), { sender: 'bot', text: answer, timestamp: new Date() });
            } catch (error) {
                console.error('Error fetching response:', error);
                document.getElementById('typing-bubble')?.parentElement.remove();
                addMessageToUI('bot', 'Sorry, something went wrong. Please try again.');
            }
        }
        
        sendBtn.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleSendMessage(); });
        document.querySelectorAll('.suggestion-chip').forEach(chip => chip.addEventListener('click', () => { chatInput.value = chip.textContent; handleSendMessage(); }));

        function showWelcomeView() { chatWelcome.classList.remove('hidden'); chatWelcome.classList.add('flex'); chatConversation.classList.add('hidden'); }
        function showConversationView() { chatWelcome.classList.add('hidden'); chatWelcome.classList.remove('flex'); chatConversation.classList.remove('hidden'); chatConversation.classList.add('flex', 'flex-col'); }

        async function startNewConversation() {
            if (!currentUserId) return;
            const newConvoRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/conversations`), { startTime: new Date(), title: "New Chat" });
            loadConversation(newConvoRef.id);
        }
        newChatBtn.addEventListener('click', startNewConversation);

        function loadConversation(conversationId) {
            if (currentConversationId === conversationId) return;
            currentConversationId = conversationId;
            chatMessages.innerHTML = '';
            showConversationView();
            if (unsubscribeMessages) unsubscribeMessages();
            const messagesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${conversationId}/messages`);
            const q = query(messagesRef, orderBy("timestamp"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                if (snapshot.empty) showWelcomeView();
                else {
                    showConversationView();
                    snapshot.forEach(doc => addMessageToUI(doc.data().sender, doc.data().text));
                }
            });
        }

        function listenForChatHistory() {
            if (unsubscribeChatHistory) unsubscribeChatHistory();
            const historyRef = collection(db, `artifacts/${appId}/users/${currentUserId}/conversations`);
            const q = query(historyRef, orderBy("startTime", "desc"));
            unsubscribeChatHistory = onSnapshot(q, (snapshot) => {
                chatHistoryContainer.innerHTML = '';
                snapshot.forEach((doc) => {
                    const firstMsgQuery = query(collection(db, doc.ref.path, 'messages'), orderBy("timestamp"), {limit: 1});
                    onSnapshot(firstMsgQuery, (msgSnapshot) => {
                        let title = msgSnapshot.empty ? "New Chat" : msgSnapshot.docs[0].data().text;
                        let btn = document.querySelector(`[data-id='${doc.id}']`);
                        if(btn) btn.querySelector('span').textContent = title;
                        else {
                            btn = document.createElement('button'); btn.dataset.id = doc.id;
                            btn.className = 'w-full flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-600 font-medium text-left';
                            btn.innerHTML = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span class="truncate">${title}</span>`;
                            btn.onclick = () => loadConversation(doc.id);
                            chatHistoryContainer.appendChild(btn);
                        }
                    });
                });
            });
        }

        // --- Gemini API Calls ---
        async function callGemini(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`API call failed: ${response.statusText}`);
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return null;
            }
        }

        async function getFollowUpSuggestions(question, answer) {
            const prompt = `Based on the following user question and AI answer, suggest exactly three concise and relevant follow-up questions the user might ask next. Return them as a JSON array of strings.
            
            Question: "${question}"
            Answer: "${answer}"
            
            Example format: ["What about X?", "How does Y affect Z?", "Tell me more about A."]`;
            
            const result = await callGemini(prompt);
            if (!result) return [];
            try {
                // Clean the response to get valid JSON
                const jsonString = result.match(/\[.*\]/s)[0];
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Failed to parse follow-up suggestions:", e, "Raw response:", result);
                return [];
            }
        }

        async function handleSummarize() {
            if (!currentUserId || !currentConversationId) return;
            summaryText.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            summaryModal.classList.remove('hidden');

            const messagesRef = collection(db, `artifacts/${appId}/users/${currentUserId}/conversations/${currentConversationId}/messages`);
            const q = query(messagesRef, orderBy("timestamp"));
            const querySnapshot = await getDocs(q);
            
            const transcript = querySnapshot.docs.map(doc => `${doc.data().sender}: ${doc.data().text}`).join('\n');
            const prompt = `Please provide a concise summary of the following medical chat conversation. Use bullet points for key topics discussed.\n\n---\n\n${transcript}`;
            
            const summary = await callGemini(prompt);
            summaryText.innerHTML = summary ? summary.replace(/\n/g, '<br>') : "Could not generate a summary.";
        }

        summarizeBtn.addEventListener('click', handleSummarize);
        closeSummaryBtn.addEventListener('click', () => summaryModal.classList.add('hidden'));
        summaryModal.querySelector('.modal-backdrop').addEventListener('click', () => summaryModal.classList.add('hidden'));

    </script>
</body>
</html>
